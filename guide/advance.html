<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>进阶 | Rallie.js</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.ec4df931.css" as="style"><link rel="preload" href="/assets/js/app.d40722f3.js" as="script"><link rel="preload" href="/assets/js/2.ccaaea31.js" as="script"><link rel="preload" href="/assets/js/3.9dc41878.js" as="script"><link rel="prefetch" href="/assets/js/10.7eb7272a.js"><link rel="prefetch" href="/assets/js/11.b565d359.js"><link rel="prefetch" href="/assets/js/12.afe84c51.js"><link rel="prefetch" href="/assets/js/13.9d9afefe.js"><link rel="prefetch" href="/assets/js/4.17cd80e5.js"><link rel="prefetch" href="/assets/js/5.e7e225c8.js"><link rel="prefetch" href="/assets/js/6.163ff0cd.js"><link rel="prefetch" href="/assets/js/7.0d948b14.js"><link rel="prefetch" href="/assets/js/8.8b712ed4.js"><link rel="prefetch" href="/assets/js/9.2f588cc8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec4df931.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Rallie.js" class="logo"> <span class="site-name can-hide">Rallie.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/introduction.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/ralliejs/rallie" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/introduction.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/ralliejs/rallie" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/guide/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/guide/install.html" class="sidebar-link">安装</a></li><li><a href="/guide/basic.html" class="sidebar-link">基础</a></li><li><a href="/guide/advance.html" aria-current="page" class="active sidebar-link">进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/advance.html#运行环境" class="sidebar-link">运行环境</a></li><li class="sidebar-sub-header"><a href="/guide/advance.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/guide/advance.html#应用治理" class="sidebar-link">应用治理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/advance.html#依赖" class="sidebar-link">依赖</a></li><li class="sidebar-sub-header"><a href="/guide/advance.html#关联" class="sidebar-link">关联</a></li><li class="sidebar-sub-header"><a href="/guide/advance.html#共享公共库" class="sidebar-link">共享公共库</a></li></ul></li></ul></li><li><a href="/guide/ecosystem.html" class="sidebar-link">生态</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h1> <h2 id="运行环境"><a href="#运行环境" class="header-anchor">#</a> 运行环境</h2> <p>在<a href="/guide/basic.html#加载-block">加载 Block</a>章节中，我们调用了<code>block.run</code>方法，通过回调参数中的运行环境对象 env 来配置应用集群的资源路径。在 Rallie 中， 应用（Block）是去中心化的，但是每个应用其实都运行在一个相同的环境下，这个运行环境可以被认为是应用集群的实质中心</p> <div align="center" style="padding:20px;"><img src="/assets/img/matrix.drawio.09fbeb1e.svg"></div> <p>对一个 Block 来说，运行环境分为两种：<strong>入口环境</strong>和<strong>非入口环境</strong>。当一个 Block 是整个集群中第一个被创建的 Block 时，可以说该 Block 运行于入口环境，否则，Block 就运行在非入口环境。我们可以通过<code>env.isEntry</code>来判断 Block 的运行环境是否是入口环境。</p> <p>以上图这个 8 个 Block 的集群为例，当你先加载<code>/app1.js</code>时，block1 是第一个被创建的应用，它将运行在入口环境，而后续加载的 Block 都将运行在非入口环境。如果你是先加载<code>/app8.js</code>，则 block8 将运行在入口环境。</p> <p>默认情况下，所有的 Block 都可以通过运行环境对象配置集群中其他 Block 的资源加载路径，Block 集群是完全去中心化的。但是，运行在入口环境的 Block 拥有一个特权——冻结运行环境。当运行环境被冻结后，其他 Block 对运行环境的配置将不生效。</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-ts"><code>block1<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  env<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    assets<span class="token operator">:</span> <span class="token punctuation">{</span>
      block2<span class="token operator">:</span> <span class="token punctuation">{</span>
        js<span class="token operator">:</span> <span class="token string">&quot;/apo2.js&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span>isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    env<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code>block2<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>env<span class="token punctuation">.</span>isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    env<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      assets<span class="token operator">:</span> <span class="token punctuation">{</span>
        block3<span class="token operator">:</span> <span class="token punctuation">{</span>
          js<span class="token operator">:</span> <span class="token string">&quot;/app3.js&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code>block3<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>env<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* block1的配置生效，block2的配置不会生效， 打印结果
   {
     block2: {
       js: [/app2.js]
     }
   }
  */</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个特性可以让你的应用集群的资源配置收归到一个配置 Block，当其他 Block 运行在入口环境时，先启动这个配置 Block，待资源被统一配置后，再冻结运行环境即可。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>需要明确的是，虽然我们可以将资源注册收归到某个配置中心，但是 Block 依然是去中心化的，你可以从任意一个入口启动应用集群，这对应用的本地开发和调试非常有用</p></div> <h2 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h2> <p>在前面的例子中，我们配置应用集群的资源路径，都是通过<code>env.config</code>方法进行静态配置，当应用数量大且经常需要扩展时，这种配置方法显然非常不灵活。为了解决这个问题，Rallie 参考了<a href="https://github.com/koajs/koa" target="_blank" rel="noopener noreferrer">koa<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的中间件设计，提供了让开发者通过中间件控制应用资源查找和加载过程的机制。</p> <p>举个例子，假如一个集群中的所有 Block 都按照<code>/${blockName}/index.js</code>的路径规范被部署到了<a href="https://www.jsdelivr.com/" target="_blank" rel="noopener noreferrer">jsdelivr<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上，那么你就可以应用这样一个中间件</p> <div class="language-ts extra-class"><pre class="language-ts"><code>block<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  env<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">loadScript</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://cdn.jsdelivr.net/npm/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样你就不必使用<code>env.config</code>手动配置应用的资源路径了。</p> <p>Rallie 的中间件是一个洋葱圈模型</p> <div align="center" style="padding:20px;"><img src="/assets/img/middleware.drawio.186d3800.svg"></div> <p>最里层的 Core 中间件会从<code>env.config</code>手动配置的资源表中查找资源并加载，在那之前你可以插入自定义的中间件，从而完全接管应用资源的查找、加载和执行全过程。基于中间件，你可以接入常见的微前端框架提供的 js 沙箱，样式隔离，html entry 等特性，甚至可以直接用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#dynamic_imports" target="_blank" rel="noopener noreferrer">动态导入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来加载应用</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果运行环境被冻结，那么运行在非入口环境的 Block 注册的中间件将不会生效</p></div> <h2 id="应用治理"><a href="#应用治理" class="header-anchor">#</a> 应用治理</h2> <h3 id="依赖"><a href="#依赖" class="header-anchor">#</a> 依赖</h3> <p>在<a href="/guide/basic.html#基础">基础</a>章节中，consumer必须等待producer初始化状态后才能执行后续操作，因此我们可以说consumer依赖了producer</p> <p>Rallie 支持通过下面的形式声明Block间的依赖关系</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token function">createBlock</span><span class="token punctuation">(</span><span class="token string">'consumer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">relyOn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'producer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onActivate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>relyOn</code>方法用于指定依赖，<code>onActivate</code>方法则用于指定依赖就绪后的回调。</p> <p>当我们需要使用consumer提供的服务时，不再调用<code>block.load</code>方法，而是调用<code>block.activate('consumer')</code>，Rallie 将会先激活consumer依赖的producer，等producer就绪后再执行consumer指定的onActivate回调。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>load方法只会加载Block的资源，而<code>activate</code>方法还会递归激活依赖并执行<code>onActivate</code>回调</p></div> <h3 id="关联"><a href="#关联" class="header-anchor">#</a> 关联</h3> <p>除了指定依赖，你也可以通过<code>relateTo</code>方法指定Block间的关联关系</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> consumer <span class="token operator">=</span> <span class="token function">createBlock</span><span class="token punctuation">(</span><span class="token string">'consumer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">relateTo</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'producer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">onActivate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>关联和依赖的区别：</strong></p> <ol><li>关联只会加载 Block 的资源，而依赖会激活 Block。</li> <li>关联不会递归传递，依赖会递归传递。也就是说，如果 block1 关联了 block2，block2 又关联了 block3，那么在激活 block1 时，只会加载 block2，而不会加载 block3，只有当激活 block2 时才会加载 block3，但是，如果 block1 依赖了 block2，block2 又依赖了 block3，那么在激活 block1 时，block2 和 block3 都会被激活</li> <li>允许互相关联，不允许互相依赖。正是因为依赖会递归传递，因此如果应用树中出现了循环依赖，就将导致<a href="https://zh.wikipedia.org/wiki/%E6%AD%BB%E9%94%81" target="_blank" rel="noopener noreferrer">死锁<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，Rallie 检测到循环依赖会抛出异常
<div align="center"><img src="/assets/img/circle.drawio.bc5a664f.svg"></div></li></ol> <h3 id="共享公共库"><a href="#共享公共库" class="header-anchor">#</a> 共享公共库</h3> <p>Rallie 把 Block 分为两类，一类是 App，其 js 资源中必须包含调用<code>registerBlock</code>注册 Block 的逻辑，然后通过 Block 实例对外提供服务，比如<a href="/guide/basic.html#基础">基础</a>章节中的 consumer 和 producer；另一类是 Library，其 js 资源中不必包含注册 Block 的逻辑，被加载之后作为整个环境的运行时使用，比如<code>React</code>、<code>Vue</code>、<code>jQuery</code>等第三方库。Rallie 通过应用名是否以<code>lib:</code>开头判断应用是 Library 还是 App</p> <div class="language-ts extra-class"><pre class="language-ts"><code>block<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  env<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    assets<span class="token operator">:</span> <span class="token punctuation">{</span>
      vue<span class="token operator">:</span> <span class="token punctuation">{</span>
        js<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/vue@3.2.24/dist/vue.global.prod.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// vue源码</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;lib:vue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        js<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/vue@3.2.24/dist/vue.global.prod.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// vue源码</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  block<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token string">&quot;lib:vue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正常运行</span>
  block<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token string">&quot;vue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出异常，因为Vue源码中不包含注册App的逻辑</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>多个 Block 往往会使用一些相同的公共库，你可以将他们声明为关联或依赖来确保资源不被重复加载</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> block <span class="token operator">=</span> <span class="token function">createBlock</span><span class="token punctuation">(</span><span class="token string">&quot;block&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">relyOn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;lib:vue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 也可以是.relateTo(['lib:vue'])</span>
  <span class="token punctuation">.</span><span class="token function">onActivate</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./app&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

block<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  env<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    assets<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;lib:vue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        js<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/vue@3.2.24/dist/vue.global.prod.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你或许已经注意到我们在<code>onActivate</code>回调中使用了<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#dynamic_imports" target="_blank" rel="noopener noreferrer">动态导入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这是因为 block 的资源会先于 Vue 源码被加载，使用动态导入可以让 block 的源码在构建时被分包，在<code>window.Vue</code>全局变量被挂载后才加载使用了 Vue 的逻辑。</p> <p>最后，我们配置一下构建工具的<code>external</code>特性即可</p> <ul><li>webpack:<div class="language-ts extra-class"><pre class="language-ts"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  externals<span class="token operator">:</span> <span class="token punctuation">{</span>
    vue<span class="token operator">:</span> <span class="token string">&quot;Vue&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li>vite:<div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> viteExternalsPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vite-plugin-externals&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">viteExternalsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      vue<span class="token operator">:</span> <span class="token string">&quot;Vue&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ralliejs/docs/edit/main/guide/advance.md" target="_blank" rel="noopener noreferrer">在Github上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/basic.html" class="prev">
        基础
      </a></span> <span class="next"><a href="/guide/ecosystem.html">
        生态
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d40722f3.js" defer></script><script src="/assets/js/2.ccaaea31.js" defer></script><script src="/assets/js/3.9dc41878.js" defer></script>
  </body>
</html>
